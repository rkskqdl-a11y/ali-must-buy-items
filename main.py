import os
import time
import random
import hmac
import hashlib
import requests
import json
from datetime import datetime

# 1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ALI_APP_KEY = os.environ.get("ALI_APP_KEY", "").strip()
ALI_SECRET = os.environ.get("ALI_SECRET", "").strip()
ALI_TRACKING_ID = os.environ.get("ALI_TRACKING_ID", "").strip()
GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY", "").strip()

def get_explosive_keywords():
    # ë” ë„“ì€ ë²”ìœ„ë¥¼ ì¡ê¸° ìœ„í•´ í‚¤ì›Œë“œë¥¼ ë” ì¼ë°˜í™”í–ˆìŠµë‹ˆë‹¤.
    categories = ["Home Gadget", "Tech Accessory", "Smart Office", "Kitchen Tool", "Outdoor Gear", "Gaming Gear"]
    modifiers = ["Best", "Top", "Essential", "New", "Cool", "Smart", "Portable", "Must Buy"]
    return [f"{m} {c}" for m in modifiers for c in categories]

def get_ali_products(keyword):
    url = "https://api-sg.aliexpress.com/sync"
    params = {
        "app_key": ALI_APP_KEY, "timestamp": str(int(time.time() * 1000)), "sign_method": "sha256",
        "method": "aliexpress.affiliate.product.query", "partner_id": "apidoc", "keywords": keyword,
        "target_currency": "USD", "target_language": "EN", "tracking_id": ALI_TRACKING_ID,
        "page_size": "50" # ğŸ¯ í•œ ë²ˆì— 50ê°œë¥¼ ë¶ˆëŸ¬ì™€ì„œ í›„ë³´ë¥¼ ëŠ˜ë¦½ë‹ˆë‹¤!
    }
    sorted_params = sorted(params.items())
    base_string = "".join([f"{k}{v}" for k, v in sorted_params])
    sign = hmac.new(ALI_SECRET.encode('utf-8'), base_string.encode('utf-8'), hashlib.sha256).hexdigest().upper()
    params["sign"] = sign
    try:
        response = requests.post(url, data=params, timeout=20)
        return response.json().get("aliexpress_affiliate_product_query_response", {}).get("resp_result", {}).get("result", {}).get("products", {}).get("product", [])
    except: return []

def generate_blog_content(product):
    # ì œë¯¸ë‚˜ì´ 3.0 FlashëŠ” Proê¸‰ ì„±ëŠ¥ì´ë©´ì„œë„ ì†ë„ê°€ ë¹ ë¦…ë‹ˆë‹¤.
    url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key={GEMINI_API_KEY}"
    headers = {'Content-Type': 'application/json'}
    prompt_text = (f"Review this product professionally: {product.get('product_title')}. "
                   f"Price: ${product.get('target_sale_price')}. Write an expert review in Markdown.")
    payload = {"contents": [{"parts": [{"text": prompt_text}]}]}
    try:
        response = requests.post(url, headers=headers, json=payload, timeout=60)
        return response.json()["candidates"][0]["content"]["parts"][0]["text"]
    except: return None

def main():
    os.makedirs("_posts", exist_ok=True)
    posted_ids = set()
    if os.path.exists("posted_ids.txt"):
        with open("posted_ids.txt", "r") as f:
            posted_ids = set(line.strip() for line in f)

    all_keywords = get_explosive_keywords()
    random.shuffle(all_keywords)
    
    success_count = 0
    # ğŸ¯ 40ê°œ ì±„ìš¸ ë•Œê¹Œì§€ ë©ˆì¶”ì§€ ì•ŠìŠµë‹ˆë‹¤!
    for target_keyword in all_keywords:
        if success_count >= 40: break
        
        print(f"ğŸ” Searching for: {target_keyword} (Current: {success_count}/40)")
        products = get_ali_products(target_keyword)
        
        # ğŸ”„ í‚¤ì›Œë“œ í•˜ë‚˜ì—ì„œ ì°¾ì€ ëª¨ë“  ìƒí’ˆ(50ê°œ)ì„ í•˜ë‚˜ì”© ê²€ì‚¬í•©ë‹ˆë‹¤.
        for product in products:
            if success_count >= 40: break
            
            p_id = str(product.get('product_id'))
            if p_id in posted_ids: continue # ì´ë¯¸ ì˜¬ë¦° ê²ƒë§Œ íŒ¨ìŠ¤
            
            content = generate_blog_content(product)
            if content:
                today = datetime.now().strftime("%Y-%m-%d")
                file_path = f"_posts/{today}-{p_id}.md"
                
                # ğŸ–¼ï¸ ì´ë¯¸ì§€ URL ìµœì í™” (https: ê°•ì œ ë¶€ì—¬)
                img_url = product.get('product_main_image_url', '')
                if img_url.startswith('//'): img_url = 'https:' + img_url
                
                buy_url = product.get('promotion_link')
                
                full_markdown = f"""---
layout: post
title: "{product['product_title']}"
date: {today}
---
![Product Image]({img_url})

{content}

---
### ğŸ›’ Limited Time Offer
<div style="text-align: center; margin: 30px 0;">
    <a href="{buy_url}" style="background-color: #ff4747; color: white; padding: 15px 25px; text-decoration: none; border-radius: 5px; font-weight: bold; font-size: 1.2em; display: inline-block;">
        Check Official Price on AliExpress â†’
    </a>
</div>
*Generated by Gemini 3.0 Intelligence*
"""
                with open(file_path, "w", encoding="utf-8") as f:
                    f.write(full_markdown)
                
                with open("posted_ids.txt", "a") as f:
                    f.write(f"{p_id}\n")
                
                posted_ids.add(p_id)
                success_count += 1
                print(f"ğŸ‰ SUCCESS ({success_count}/40): {p_id}")
                time.sleep(2) # âš¡ ì†ë„ë¥¼ ìœ„í•´ íœ´ì‹ ì‹œê°„ì„ 10ì´ˆ -> 2ì´ˆë¡œ ì¤„ì˜€ìŠµë‹ˆë‹¤.
    
    print(f"ğŸ Mission Completed: {success_count} posts created.")

if __name__ == "__main__":
    main()
